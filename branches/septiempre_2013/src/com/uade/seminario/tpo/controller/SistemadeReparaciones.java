package com.uade.seminario.tpo.controller;
import java.sql.Date;
import java.util.ArrayList;
import java.util.Vector;

import com.uade.seminario.tpo.service.ClienteService;
import com.uade.seminario.tpo.service.EmpleadoService;
import com.uade.seminario.tpo.view.objectView.ClienteView;
import com.uade.seminario.tpo.view.objectView.EquipoView;
import com.uade.seminario.tpo.view.objectView.ModeloView;
import com.uade.seminario.tpo.view.objectView.OrdenReparacionView;
import com.uade.seminario.tpo.view.objectView.PiezaView;
import com.uade.seminario.tpo.view.objectView.TareaReparacionView;

import com.uade.seminario.tpo.exceptions.ExceptionExisteCliente;
import com.uade.seminario.tpo.exceptions.ExceptionExisteModelo;
import com.uade.seminario.tpo.exceptions.ExceptionModeloInactivo;
import com.uade.seminario.tpo.exceptions.ExceptionModeloPerteneceEquipo;
import com.uade.seminario.tpo.exceptions.ExceptionNoExisteModelo;
import com.uade.seminario.tpo.exceptions.ExceptionNoHayStock;

import com.uade.seminario.tpo.model.Cliente;
import com.uade.seminario.tpo.model.ClienteId;
import com.uade.seminario.tpo.model.Empleado;
import com.uade.seminario.tpo.model.Equipo;
import com.uade.seminario.tpo.model.Garantia;
import com.uade.seminario.tpo.model.Modelo;
import com.uade.seminario.tpo.model.OrdenReparacion;
import com.uade.seminario.tpo.model.Pieza;
import com.uade.seminario.tpo.model.Remito;
import com.uade.seminario.tpo.model.Reporte;
import com.uade.seminario.tpo.model.TareaReparacion;

//
//
//  Generated by StarUML(tm) Java Add-In
//
//  @ Project : Untitled
//  @ File Name : Sistema de Reparaciones.java
//  @ Date : 29/07/2013
//  @ Author : 
//
//




public class SistemadeReparaciones {
	private static SistemadeReparaciones instancia;
	private Vector<Remito> remitos;
	private Vector<Garantia> garantias;
	private Vector<Modelo> modelos;
	private Vector<Pieza> piezas;
	private Vector<OrdenReparacion> ordReparacion;
	private Vector<Equipo> equipos;
	private ArrayList<Cliente> clientes;
	private ArrayList<Empleado> empleados;
	private Vector<Reporte> reportes;
	
	private SistemadeReparaciones(){
		this.remitos=new Vector<Remito>();
		this.garantias=new Vector<Garantia>();
		this.modelos=new Vector<Modelo>();
		this.piezas=new Vector<Pieza>();
		this.ordReparacion=new Vector<OrdenReparacion>();
		this.empleados=new ArrayList<Empleado>();
		this.equipos=new Vector<Equipo>();
		this.clientes= new ArrayList<Cliente>();
		this.reportes=new Vector<Reporte>();
	}
	
	public static SistemadeReparaciones getInstancia(){
		if(instancia==null)
			instancia=new SistemadeReparaciones();
		return instancia;
	}
	
	public void altaModelo(String nombre,int codigo,String descripcion){   
		Modelo modelo=buscarModelo(codigo);
		if(modelo==null){
			modelo=new Modelo(nombre,descripcion,codigo);
			modelos.add(modelo);
		}
		else
			throw new ExceptionExisteModelo(codigo);
	}
	
	public void modificarModelo(int codigo, String nombre, String descripcion){							
		Modelo modelo=this.buscarModelo(codigo);
		if(modelo!=null && modelo.modeloActivo()){
			modelo.setDescripcion(descripcion);
			modelo.setNombre(nombre);
		}
		else
			throw new ExceptionNoExisteModelo(codigo);
		
	}
	
	public void bajaModelo(int codigo) throws ExceptionModeloInactivo{
		Modelo modelo=this.buscarModelo(codigo);
		if(modelo!=null && modelo.modeloActivo()){
			if(!existeElModeloEnUnEquipo(codigo)){
				modelo.darBajaModelo();
			}
			else{
				throw new ExceptionModeloPerteneceEquipo(codigo);
			}
		}
		else{
			if(modelo==null)
				throw new ExceptionNoExisteModelo(codigo);
			else
				throw new ExceptionModeloInactivo(codigo);
			
		}
		
	}
	
	public void eliminarModelo(int codigo) {
		Modelo modelo=this.buscarModelo(codigo);
		if(modelo!=null){
			modelo.eliminar();
			modelos.remove(modelo);
		}
		
	}
	
	

	public boolean existeElModeloEnUnEquipo(int codigo) {
		for (Equipo equipo : equipos) {
			if(equipo.getModelo().getNroModelo()==codigo)
				return true;
		}
		return false;
	}

	public Modelo buscarModelo(int codigo) {
		for (Modelo modelo : modelos) {
			if(modelo.getNroModelo()==codigo){
				return modelo;
			}
		}
		return null;
	}
	
	
	public int altaOrdenReparacion(int nroSerieEquipo){
		Equipo equipo=buscarEquipo(nroSerieEquipo);
		OrdenReparacion or=BuscarEquipoxOrdenRep(nroSerieEquipo);
		if(equipo!=null && or==null){
			int nroOrden=this.obtenerNroOrdenReparacion();
			OrdenReparacion orden=new OrdenReparacion(nroOrden);
			orden.setEquipo(equipo);
			orden.setEstado("A confirmar");
			return nroOrden;
		}
		else
			return 0;
		
	}

	public void modificarOrdenReparacion(int nroReparacion, String fallas, int prioridad){
		OrdenReparacion orden=buscarOrdenReparacion(nroReparacion);
		if(orden!=null && !orden.getEstado().equals("Reparado")){
			orden.setDescripcionFallas(fallas);
			orden.setPrioridad(prioridad);
		}
			
		
	}
	
	public OrdenReparacion buscarOrdenReparacion(int nroReparacion) {
		// TODO Auto-generated method stub
		return null;
	}

	

	private OrdenReparacion BuscarEquipoxOrdenRep(int nroSerieEquipo) {
		for (OrdenReparacion or : ordReparacion) {
			if(or.esTuEquipo(nroSerieEquipo) && or.estadoAReparar()){
				return or;
			}
		}
		return null;
	}

	public Equipo buscarEquipo(int nroSerieEquipo) {
		for (Equipo equipo : equipos) {
			if(equipo.getNroSerie()==nroSerieEquipo)
				return equipo;
		}
		return null;
	}
	
	public OrdenReparacionView misReparaciones(String legajo){
		Empleado empleado=buscarEmpleado(legajo);
		if(empleado!=null){
			if(!empleado.hayOrdenReparacion()){
				OrdenReparacion orden= this.buscarOrdenReparacionPrioridad();
				empleado.addAReparar(orden);
				return orden.getView();
			}
			else
				return empleado.getaReparar().get(0).getView();
		}
		else
			return null;		
	}

	public OrdenReparacion buscarOrdenReparacionPrioridad() { //SE supone que el vector esta ordenado de mayor a menor segun el numero de prioridad!
		for (OrdenReparacion orden : ordReparacion) {
			if(orden.estadoAReparar())
				return orden;
		}		
		return null;
	}

	private Empleado buscarEmpleado(String legajo) {
		EmpleadoService empleadoService = EmpleadoService.getInstance();
		for (Empleado empleado : empleados) {
			if(empleado.getLegajo().equals(legajo)) 
				return empleado;
		}
		
		Empleado empleado=empleadoService.findByLegajo(legajo);
		if (empleado != null){
			empleados.add(empleado);//bring the client to memory for future reference
		}
		return empleado;
	}
	
	public TareaReparacion crearTareaReparacion(String descripcion,Vector<Pieza> piezas){     //VER COMO SERIA LA CONFIRMACION
		int nroTarea=generarNroTarea();
		boolean stock=true;
		for (Pieza pieza : piezas) {
			if(!pieza.hayStock()){
				stock=false;
				throw new ExceptionNoHayStock(pieza.getNroPieza());
			}
		}
		if(stock){
			TareaReparacion tarea=new TareaReparacion(nroTarea,descripcion);
			tarea.setPiezas(piezas);
			tarea.setEstado("Activa");
			return tarea;
		}
		else
			return null;
			
	}
	
	public void modificarTareaReparacion(int nroReparacion){
		TareaReparacion tarea=buscarTareaReparacion(nroReparacion);
		
	}
	
	public void bajaTareaReparacion(int nroReparacion){
		TareaReparacion tarea=buscarTareaReparacion(nroReparacion);
		if(tarea!=null && tarea.estaActiva()){
			tarea.setEstado("Inactiva");
		}
		
	}
	
	public Vector<TareaReparacionView> listarTareasReparacion(int nroReparacion){
		OrdenReparacion orden=buscarOrdenReparacion(nroReparacion);
		if(orden!=null){
			return orden.listarTareasView();
		}
		return null;
		
	}
	
	public void emitirReportePiezas(Date desde,Date hasta){
		Vector<OrdenReparacion> ordenes=buscarOrdenesReporte(desde,hasta);
		generarListaPiezas(ordenes);
	}

	public void generarListaPiezas(Vector<OrdenReparacion> ordenes) {
		for (OrdenReparacion ordenReparacion : ordenes) {
			ordenReparacion.listaPiezas();
		}
	}

	public Vector<OrdenReparacion> buscarOrdenesReporte(Date desde, Date hasta) {
		// TODO Auto-generated method stub
		return null;
	}

	private TareaReparacion buscarTareaReparacion(int nroReparacion) {
		// TODO Auto-generated method stub
		return null;
	}

	private int generarNroTarea() {
		// TODO Auto-generated method stub
		return 0;
	}

	public void altaCliente(String nroDoc, String tipoDoc, String nombre, String apellido,
			String direccion, String mail, String fechaNac, String tel) {
		Cliente cliente;
		ClienteService clienteService = ClienteService.getInstance();
		cliente =  buscarCliente(nroDoc, tipoDoc);
		if(cliente==null){//if client is not in memory, search into the DB
			cliente=clienteService.findByDNI(nroDoc, tipoDoc);			
		}
		if(cliente==null){// client not exist in the system
			cliente=new Cliente(nroDoc,tipoDoc,nombre,apellido,direccion,mail,fechaNac,tel);
			clientes.add(cliente);
			clienteService.save(cliente);
		}else {
			throw new ExceptionExisteCliente(nroDoc);
		}
		
	}

	private Cliente buscarCliente(String nroDoc, String tipoDoc) {
		ClienteId id= new ClienteId(nroDoc, tipoDoc);
		ClienteService clienteService = ClienteService.getInstance();
		for (Cliente cliente : clientes) {
			if(cliente.getId().equals(id)) 
				return cliente;
		}
		
		Cliente cliente=clienteService.findByDNI(nroDoc, tipoDoc);
		if (cliente != null){
			clientes.add(cliente);//bring the client to memory for future reference
		}
		return cliente;
	}

	public ClienteView obtenerClienteView(String nroDoc,String tipoDoc) {
		Cliente cliente=buscarCliente(nroDoc,tipoDoc);
		if(cliente!=null)
			return cliente.getView();
		else
			return null;
	}

	public void modificarCliente(String nroDoc, String tipoDoc,String nombre1, String dir, String tel,
			String mail) {
		Cliente cliente=buscarCliente(nroDoc,tipoDoc);
		cliente.setNombre(nombre1);
		cliente.setDireccion(dir);
		cliente.setTelefono(tel);
		cliente.setEmail(mail);		
	}

	public void altaPieza(String nombre, int codPieza, int codModelo, String descripcion) {
		Modelo modelo=buscarModelo(codModelo);
		Pieza pieza=buscarPieza(codPieza);
		if(modelo!=null && pieza==null){
			pieza=new Pieza(codPieza,nombre,descripcion);
			modelo.addPieza(pieza);
			piezas.add(pieza);
		}
		
	}

	private Pieza buscarPieza(int codPieza) {
		for (Pieza pieza : piezas) {
			if(pieza.getNroPieza()==codPieza)
				return pieza;
		}
		return null;
	}

	public PiezaView buscarPiezaView(int codigoPieza) {
		Pieza pieza=buscarPieza(codigoPieza);
		if(pieza!=null)
			return pieza.getView();
		else
			return null;
	}

	public void modificarPieza(String nombre, int codPieza,
			String descripcion) {
		Pieza pieza=buscarPieza(codPieza);
		if(pieza!=null){
			pieza.setNombrePieza(nombre);
			pieza.setDescripcion(descripcion);
		}
		
	}

	public void BajaPieza(int codigoPieza) {
		Pieza pieza=buscarPieza(codigoPieza);
		if(pieza!=null && !hayModelosConPieza(codigoPieza)){
			pieza.darBajaPieza();
		}
		
		
	}

	private boolean hayModelosConPieza(int codigoPieza) {
		// TODO Auto-generated method stub
		return false;
	}

	public ModeloView buscarModeloView(int codModelo) {
		Modelo modelo=buscarModelo(codModelo);
		if(modelo!=null)
			return modelo.getView();
		else
			return null;
	}

	public Vector<PiezaView> buscarPiezaXModeloView(int codModelo) {
		 Vector<PiezaView> piezasview=new Vector<PiezaView>();
		 Modelo modelo=buscarModelo(codModelo);
		 if(modelo!=null){
			 Vector<Pieza> piezas=modelo.getPiezas();
			 for (Pieza p : piezas) {
				piezasview.add(p.getView());				
			}
		 }
		 return piezasview;
	}

	public void confirmarModelo(int codigo) {
		Modelo modelo= buscarModelo(codigo);
		if(modelo!=null)
			modelo.activar();
		else
			throw new ExceptionNoExisteModelo(codigo);
		
	}
	public void altaEquipo(int nroEquipo,int nroModelo,String tipoDoc,String nroDoc,Date fecha,String nroGarantia,boolean repararDeTodosModos){
		Equipo equipo=buscarEquipo(nroEquipo);
		Modelo modelo=buscarModelo(nroModelo);
		Cliente cliente=buscarCliente(nroDoc, tipoDoc);
		Garantia garantia1=null;
		if(!nroGarantia.equals(""))
			garantia1=buscarGarantia(Integer.parseInt(nroGarantia));
		if(equipo==null && modelo!=null && cliente!=null){
			equipo=new Equipo(nroEquipo,modelo,cliente,garantia1);
		}
		
	}

	private Garantia buscarGarantia(int nroGarantia) {
		for (Garantia garantia : garantias) {
			if(garantia.getNroGarantia()==nroGarantia)
				return garantia;			
		}
		return null;
	}

	public void altaGarantia(int nroGarantia, Date fecha1) {
		Garantia garantia=buscarGarantia(nroGarantia);
		if(garantia==null){
			garantia=new Garantia(nroGarantia,fecha1);
			garantias.add(garantia);
		}
	}

	public void quitarPiezaModelo(int codigoModelo, int nroPieza) {
		Modelo modelo=buscarModelo(codigoModelo);
		Pieza pieza=buscarPieza(nroPieza);
		if(modelo!=null && pieza!=null){
			modelo.quitarPieza(pieza);
		}
		
	}

	public void agregarPiezaModelo(PiezaView piezaV, int codigoModelo) {
		Modelo modelo=buscarModelo(codigoModelo);
		Pieza pieza=buscarPieza(piezaV.getNroPieza());
		if(modelo!=null && pieza!=null){
			modelo.addPieza(pieza);
		}
		
	}

	public EquipoView buscarEquipoView(int nroSerie) {
		Equipo equipo=buscarEquipo(nroSerie);
		if(equipo!=null && equipo.estaActivo()){
			EquipoView equipoV=equipo.getView();
			return equipoV;
		}
		else
			return null;
	}

	public OrdenReparacionView buscarOrdenConEquipoARepararView(int nroSerie) {
		Equipo equipo=buscarEquipo(nroSerie);
		if(equipo!=null){
			for (OrdenReparacion orden : ordReparacion) {
				if(orden.estadoAReparar() && orden.esTuEquipo(nroSerie)){
					return orden.getView();
				}
			}
		}
		return null;
	}

	public int obtenerNroOrdenReparacion() {
		
		return (ordReparacion.size()+1);
	}

	public Vector<TareaReparacionView> buscarTareasXOrdenReparacionView(int nroOrdenReparacion) {
		Vector<TareaReparacionView> tareasview=new Vector<TareaReparacionView>();
		 OrdenReparacion orden=buscarOrdenReparacion(nroOrdenReparacion);
		 if(orden!=null){
			 Vector<TareaReparacion> tareas=orden.getItemsReparacion();
			 for (TareaReparacion t : tareas) {
				 if(t.estaActiva())
					 tareasview.add(t.getView());				
			}
		 }
		 return tareasview;
	}

	public OrdenReparacionView buscarOrdenReparacionView(int nroOrden) {
		OrdenReparacion orden=this.buscarOrdenReparacion(nroOrden);
		if(orden!=null){
			return orden.getView();			
		}
		return null;
	}

	public int crearTareaReparacion(String descripcion, int numeroOrden) {
		OrdenReparacion orden=buscarOrdenReparacion(numeroOrden);
		if(orden!=null && !orden.getEstado().equals("Reparado")){
			int numeroTarea=obtenerNumeroTarea(orden);
			TareaReparacion tarea=new TareaReparacion(numeroTarea, descripcion);
			orden.agregarItemReparacion(tarea);
			return numeroTarea;
		}
		return 0;
		
	}

	private int obtenerNumeroTarea(OrdenReparacion orden) {
		return orden.getItemsReparacion().size()+1;
	}

	public Vector<PiezaView> buscarPiezasXTareaView(int nroOrden, int nroTarea) {
		Vector<PiezaView> piezas=new Vector<PiezaView>();
		OrdenReparacion orden=buscarOrdenReparacion(nroOrden);
		if(orden!=null){
			TareaReparacion tarea=orden.obtenerTarea(nroTarea);
			if(tarea!=null){
				for (Pieza pieza : tarea.getPiezas()) {
					piezas.add(pieza.getView());
				}
			}
		}
		return piezas;
	}

	public void agregarPiezaTarea(int nroOrden, int nroTarea, int nroPieza) {
		OrdenReparacion orden=buscarOrdenReparacion(nroOrden);
		Pieza pieza=buscarPieza(nroPieza);
		if(orden!=null){
			TareaReparacion tarea= orden.obtenerTarea(nroTarea);
			if(tarea!=null){
				tarea.agregarPieza(pieza);
			}
		}
		
		
	}

	public void quitarPiezaTarea(int nroOrden, int nroTarea, int nroPieza) {
		OrdenReparacion orden=buscarOrdenReparacion(nroOrden);
		Pieza pieza=buscarPieza(nroPieza);
		if(orden!=null){
			TareaReparacion tarea= orden.obtenerTarea(nroTarea);
			if(tarea!=null){
				tarea.quitarPieza(pieza);
			}
		}
		
	}

	public void quitarTareaOrdenReparacion(int nroOrden, int nroTarea) {
		OrdenReparacion orden=buscarOrdenReparacion(nroOrden);
		if(orden!=null){
			TareaReparacion tarea=orden.obtenerTarea(nroTarea);
			if(tarea!=null && tarea.estaActiva()){
				tarea.setEstado("inactivo");
			}
		}
		
	}

	public void confirmarOrdenReparacion(int nroOrden, String fallas, boolean estaEnGarantiaFisica,boolean repararDeTodosModos, int prioridad1) {
		OrdenReparacion orden=buscarOrdenReparacion(nroOrden);
		if(orden!=null){
			orden.setDescripcionFallas(fallas);
			orden.setEstaEnGarantiaFisica(estaEnGarantiaFisica);
			orden.setRepararDeTodosModos(repararDeTodosModos);
			orden.setPrioridad(prioridad1);
			
			if(repararDeTodosModos||(orden.getEquipo().getGarantia().estasEnGarantia() && estaEnGarantiaFisica) ){
				orden.setEstado("A reparar");
			}
			else{
				orden.setEstado("Presupuestar");
			}
			
		}
		
	}


	

	
}
